<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>

    <title>OpenSeadragon</title>

    <link rel='stylesheet' type='text/css' media='screen' href='/style.css'/>
    <link rel="stylesheet"  href="/openseadragon-2.4.2/annotorious.min.css" type='text/css'/>

    <script src="/openseadragon-2.4.2/openseadragon.min.js"></script>
    <script src="/openseadragon-2.4.2/openseadragon-annotorious.min.js"></script>
    <!-- Toolbar plugin -->
    <script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-toolbar@latest/dist/annotorious-toolbar.min.js"></script>

    <script>window.onload = function() {

      var viewer = OpenSeadragon({
        id:              "contentDiv",
        prefixUrl:       "/openseadragon-2.4.2/images/",
        tileSources:     "/api/deepzoom/study1/slides.dzi",  //"https://openseadragon.z13.web.core.windows.net/slides.dzi",
        gestureSettingsTouch: {
          pinchRotate: true
        },
        showRotationControl: true,
        showFlipControl: true,
        constrainDuringPan: true,
      });
      
      var anno = OpenSeadragon.Annotorious(viewer, {
        locale: 'auto'
      });

      // Init toolbar plugin
      Annotorious.Toolbar(anno, document.getElementById('my-toolbar-container'));

      setUserInfo();

      anno.on('createSelection', function(selection) {
        console.log('selection', selection);
      });

      anno.on('selectAnnotation', function(annotation) {
        console.log('selected', annotation);
      });

      anno.on('cancelSelected', function(a) {
        console.log('cancelSelected', a);
      });

      anno.on('mouseEnterAnnotation', function(annotation) {
        // console.log('mouseEnter', annotation);
      });

      anno.on('mouseLeaveAnnotation', function(annotation) {
        // console.log('mouseLeave', annotation);
      });

      //anno.loadAnnotations('annotations.w3c.json');
    

      async function getUserInfo() {
        const response = await fetch('/.auth/me');
        const payload = await response.json();
        const { clientPrincipal } = payload; 
        return clientPrincipal;
      }

      async function setUserInfo() {
        let  clientPrincipal =  await getUserInfo();

        anno.setAuthInfo({
          id: clientPrincipal.userId,
          displayName: clientPrincipal.userDetails
        });

        document.getElementById("user").innerHTML = clientPrincipal.userDetails + ' at ' + clientPrincipal.identityProvider;
        console.log(clientPrincipal);
      }

     

    }
    </script>
</head>

<body>
      <div class="demoarea">
        <div class="demoheading" style="display: flex;">
            User: &nbsp <b><div id="user"  ></div> </b>
            <span id='consolelog'></span>
         </div>
         <div class="demoheading">   
            <p class="instructions">Click the annotation to edit. Hold <strong>SHIFT</strong> while clicking and dragging the mouse to create a new annotation.</p>
            <!-- The toolbar mounts itself into a DIV on your page -->
            <div id="my-toolbar-container"></div> 
        </div>
        <div id="contentDiv" class="openseadragon"></div>
     </div>
</body>
</html>